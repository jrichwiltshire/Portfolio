<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Dashboard | Jared Wiltshire</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css">
    <style>
        body { max-width: 1200px; margin: auto; padding: 20px; }
        .controls { background: #f0f4f8; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap; }
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        input[type="text"], input[type="range"] { width: 250px; }
        .stats { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-card { background: #e1f5fe; padding: 15px; border-radius: 8px; flex: 1; text-align: center; border: 1px solid #b3e5fc; }
        .applied-tag { color: white; background: #27ae60; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
        .new-tag { color: white; background: #3498db; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
        tr:hover { background-color: #f9f9f9; }
        details { cursor: pointer; color: #555; font-size: 0.9em; }
        summary { font-weight: bold; color: #2980b9; }
        .pitch-content { margin-top: 5px; color: #444; white-space: pre-wrap; font-size: 0.85rem; }
    </style>
</head>
<body>
    <h1>Job Search Automation</h1>
    
    <div class="stats">
        <div class="stat-card"><h3><span id="total-jobs">0</span></h3><p>Total Opportunities</p></div>
        <div class="stat-card"><h3><span id="applied-count">0</span></h3><p>Applications Sent</p></div>
    </div>

    <div class="controls">
        <div class="control-group">
            <label for="search">Search Title or Company</label>
            <input type="text" id="search" placeholder="e.g. Data Scientist, Roblox...">
        </div>
        <div class="control-group">
            <label for="salary">Min Salary: $<span id="salary-val">0</span>k</label>
            <input type="range" id="salary" min="0" max="250" value="0">
        </div>
        <button onclick="resetFilters()">Reset</button>
    </div>

    <div id="loading">Connecting to SQLite database...</div>
    <table id="job-table" style="display:none;">
        <thead>
            <tr>
                <th>Date</th>
                <th>Company</th>
                <th>Title</th>
                <th>Salary</th>
                <th>Pitch</th>
                <th>Status</th>
                <th>Link</th>
            </tr>
        </thead>
        <tbody id="job-list"></tbody>
    </table>

    <script>
        let db;
        const searchInput = document.getElementById('search');
        const salaryInput = document.getElementById('salary');
        const salaryVal = document.getElementById('salary-val');

        async function init() {
            try {
                const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}` });
                const response = await fetch('job_aggregator.db');
                const buf = await response.arrayBuffer();
                db = new SQL.Database(new Uint8Array(buf));
                
                // Set initial stats
                updateStats();
                // Render initial table
                renderTable();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('job-table').style.display = 'table';

                // Listen for changes
                searchInput.addEventListener('input', renderTable);
                salaryInput.addEventListener('input', () => {
                    salaryVal.innerText = salaryInput.value;
                    renderTable();
                });
            } catch (err) {
                console.error(err);
                document.getElementById('loading').innerText = "Error loading database: " + err.message;
                document.getElementById('loading').style.color = "red";
            }
        }

        function updateStats() {
            const total = db.exec("SELECT COUNT(*) FROM jobs")[0].values[0][0];
            const applied = db.exec("SELECT COUNT(*) FROM jobs WHERE applied = 1")[0].values[0][0];
            document.getElementById('total-jobs').innerText = total;
            document.getElementById('applied-count').innerText = applied;
        }

        function renderTable() {
            const searchTerm = `%${searchInput.value}%`;
            const minSal = salaryInput.value * 1000;
            
            // Re-run SQL query with filters
            const query = `
                SELECT posted_date, company, title, min_salary, max_salary, why_me, applied, link 
                FROM jobs 
                WHERE (title LIKE ? OR company LIKE ?) 
                AND (min_salary >= ? OR min_salary IS NULL)
                ORDER BY posted_date DESC 
                LIMIT 100
            `;
            
            const stmt = db.prepare(query);
            stmt.bind([searchTerm, searchTerm, minSal]);
            
            const tbody = document.getElementById('job-list');
            tbody.innerHTML = '';

            while (stmt.step()) {
                const row = stmt.get();
                // row: [0:date, 1:co, 2:title, 3:min, 4:max, 5:why, 6:app, 7:link]
                
                let salaryDisplay = 'N/A';
                if (row[3]) {
                    const minK = Math.round(row[3] / 1000) + 'k';
                    if (row[4] && row[4] > row[3]) {
                        const maxK = Math.round(row[4] / 1000) + 'k';
                        salaryDisplay = `$${minK} - $${maxK}`;
                    } else {
                        salaryDisplay = `$${minK}`;
                    }
                }

                const pitchHtml = row[5] ? 
                    `<details><summary>Why Me?</summary><div class="pitch-content">${row[5]}</div></details>` : 
                    '<span style="color:#ccc;">-</span>';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row[0]}</td>
                    <td><strong>${row[1]}</strong></td>
                    <td>${row[2]}</td>
                    <td>${salaryDisplay}</td>
                    <td>${pitchHtml}</td>
                    <td>${row[6] == 1 ? '<span class="applied-tag">Applied</span>' : '<span class="new-tag">New</span>'}</td>
                    <td><a href="${row[7]}" target="_blank">View Job</a></td>
                `;
                tbody.appendChild(tr);
            }
            stmt.free();
        }

        function resetFilters() {
            searchInput.value = '';
            salaryInput.value = 0;
            salaryVal.innerText = '0';
            renderTable();
        }

        init();
    </script>
</body>
</html>
